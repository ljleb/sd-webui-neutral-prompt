# Neutral Prompt

Neutral prompt is an a1111 webui extension that enhances the webui's CFG denoising algorithm. It replaces the original algorithm with a higher-quality implementation based on more recent research.

## Features

- [Perp-Neg](https://perp-neg.github.io/) CFG algorithm, invoked using the `AND_PERP` keyword
- saliency-aware noise blending, invoked using the `AND_SALT` keyword (credits to [Magic Fusion](https://magicfusion.github.io/) for the algorithm used to determine SNB maps from epsilons)
- standard deviation based CFG rescaling (Reference: https://arxiv.org/abs/2305.08891)

## Usage

### Keyword `AND_PERP`

The `AND_PERP` keyword, standing for "perpendicular `AND`", integrates the Perp-Neg CFG algorithm. Essentially, `AND_PERP` allows for prompting concepts that highly overlap with regular prompts, by negating contradicting noise.

You could visualize it as such: if `AND` prompts are "greedy" (taking as much space as possible in the output), `AND_PERP` prompts are opposite, relinquishing control as soon as there is a disagreement in the generated output.

### Keyword `AND_SALT`

Saliency-aware noise blending is made possible using the `AND_SALT` keyword, shorthand for "`AND` SALienT". In essence, `AND_SALT` monitors high noise activity during denoising and dominates any high-activation regions in the output.

Think of it as a territorial dispute: the noise generated by the `AND` prompts is one country, and the noise(s) generated by `AND_SALT` prompts represent neighbouring nations. They're all vying for the same land - whoever strikes the strongest at a given time and location claims it.

## Examples

### Using the `AND_PERP` Keyword

Here is an example to illustrate one use case of the `AND_PREP` keyword. Prompt:

`beautiful castle landscape AND monster house castle :-1`

This is an XY grid with prompt S/R `AND, AND_PERP`:

![image](https://github.com/ljleb/sd-webui-neutral-prompt/assets/32277961/29f3cf34-2ed4-45d2-b73a-b6fadec21d61)

Key observations:

- The `AND_PERP` images exhibit a higher dynamic range compared to the `AND` images.
- The `AND` images sometimes struggle to depict a castle, a challenge not encountered by the `AND_PERP` images.
- The `AND` images tend to lean towards a purple color, because this was the path of least resistance between the two opposing prompts during generation. In contrast, the `AND_PERP` images, free from this tug-of-war, present a clearer representation.

### Using the `AND_SALT` Keyword

The AND_SALT keyword introduces a unique process called saliency-aware noise blending. It spotlights and accentuates areas of high-activation, or more pronounced, noise in the output.

Consider this example prompt utilizing `AND_SALT`:

```
a scenic green forest
AND_SALT [
    a rare bird perched on a branch
    AND a roaring river in the distance :1.5
    AND_SALT a group of deer grazing nearby :-0.5
] :1.1
AND a clear blue sky overhead :0.8
```

In this example, the extension performs the following actions:

1. Use the noise generated from the prompt `a group of deer grazing nearby :-0.5`
2. The extension focuses on areas of the noise from the previous step that are most active or salient. This portion of the noise is then removed from the combined noise of the other prompts within the AND_SALT bracket (`a rare bird perched on a branch :1` and `a roaring river in the distance :1.5`)
3. The processed noise from the previous steps is then combined
4. The extension, once again, identifies and maintains only the high-activation regions in the resulting noise. These areas of interest are determined based on the combined noise from `a scenic green forest :1` and `a clear blue sky overhead :0.8`
5. The resultant high-activation noise (multiplied by 1.1) is combined with the overall noise from the prompts that it was compared against.

The `AND_SALT` keyword provides a targeted denoising space within its square brackets `[...]`. In this space, prompts are merged into a single noise map before additional processing.

Using `AND_SALT`, you can gain precise control over the high-activation details of your outputs.

## Advanced Features

### Nesting AND_PERP prompts

The extension enables nesting prompts orthogonal to other perpendicular prompts:

```
a red hot desert canion
AND_PERP [
    cold blue everest montain
    AND a beautiful woman climbing a massive rocks wall :1.1
    AND_PERP far away, ugly, ants, water :-0.6
] :0.9
AND a rocky sahara climbing party :0.7
```

To generate the final noise from the diffusion model, the extension will:

1. Use the noise generated from the prompt `far away, ugly, ants, water :-0.6`
2. Make it orthogonal to the combination of `cold blue Everest mountain :1` and `a beautiful woman climbing a massive rock wall :1.1`
3. Add this orthogonal noise to the combined prompts it was orthogonalized against
4. Make the resulting noise orthogonal to the combination of `a red hot desert canyon :1` and `a rocky Sahara climbing party :0.7`
5. Add this orthogonal noise (multiplied by 0.9) to the combined prompts it was orthogonalized against

The final single noise map is composed of all normal `AND` prompts combined with all orthogonalized `AND_PERP` prompts.

Each instance of the `AND_PERP` keyword delineates a separate denoising space within its square brackets `[...]`. Prompts inside it merge into a single noise map before further processing down the prompt tree.

Experimental evidence suggests that it's unnecessary to go beyond a depth of 2. We're still exploring if this adds to the precision of the generations. If you discover innovative ways of controlling the generations using nested `AND_PERP` prompts, please share in the discussions!

![image](https://github.com/ljleb/sd-webui-neutral-prompt/assets/32277961/f6d0c95b-8efd-4ce2-b5e4-928597facd34)

## Known issues

- The webui doesn't support composable diffusion via [`AND`](https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Features#composable-diffusion) for samplers DDIM, PLMS, and UniPC. As Perp-Neg relies on composable diffusion, the extension will revert to the unmodified sampler implementation when these are used.

## Special Mentions

Special thanks to these people for helping make this extension possible:

- [Ai-Casanova](https://github.com/AI-Casanova) : for sharing mathematical knowledge, time, and conducting proof-testing to enhance the robustness of this extension
